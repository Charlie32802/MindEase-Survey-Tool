<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="MindEase"/>
<meta name="theme-color" content="#4169E1"/>
<title>MindEase Testing Portal</title>
<link rel="icon" type="image/png" href="logo.png"/>
<link rel="apple-touch-icon" href="logo.png"/>
<link rel="manifest" href="manifest.json"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4169E1",
            "background-light": "#F8F9FA",
            "background-dark": "#101214",
            "text-light": "#343A40",
            "text-dark": "#E9ECEF",
          },
          fontFamily: {
            "display": ["Manrope", "sans-serif"]
          },
        },
      },
    }
</script>
<style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    .screen { 
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .screen.active { 
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .animate-slide-in {
      animation: slideIn 0.3s ease forwards;
    }
    .tab-button {
      transition: all 0.3s ease;
    }
    .tab-button.active {
      background: #4169E1;
      color: white;
    }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">

<!-- Main Navigation Tabs -->
<nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 z-50 safe-area-inset">
  <div class="flex max-w-md mx-auto">
    <button onclick="showHomeTab()" id="tab-home" class="tab-button active flex-1 flex flex-col items-center py-3 px-4">
      <span class="material-symbols-outlined text-2xl mb-1">home</span>
      <span class="text-xs font-medium">Home</span>
    </button>
    <button onclick="showResultsTab()" id="tab-results" class="tab-button flex-1 flex flex-col items-center py-3 px-4 text-gray-600 dark:text-gray-400">
      <span class="material-symbols-outlined text-2xl mb-1">bar_chart</span>
      <span class="text-xs font-medium">Results</span>
    </button>
  </div>
</nav>

<div class="pb-20 max-w-md mx-auto">

<!-- HOME TAB - Mode Selection -->
<div id="home-tab" class="screen active flex-col min-h-screen p-6">
  <div class="flex-1 flex flex-col items-center justify-center">
    <div class="flex items-center justify-center h-20 w-20 bg-primary/20 rounded-2xl mb-6">
      <span class="material-symbols-outlined text-primary text-5xl">science</span>
    </div>
    <h1 class="text-3xl font-bold text-center mb-3">MindEase Testing</h1>
    <p class="text-gray-600 dark:text-gray-400 text-center mb-12">Select your testing group</p>
    
    <div class="w-full space-y-4">
      <button onclick="startSurvey('alpha')" class="group w-full bg-primary hover:bg-primary/90 active:scale-95 text-white rounded-2xl p-6 shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between">
          <div class="text-left">
            <h3 class="text-xl font-bold mb-1">Alpha Testing</h3>
            <p class="text-white/80 text-sm">System validation & technical</p>
          </div>
          <span class="material-symbols-outlined text-4xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
        </div>
      </button>
      
      <button onclick="startSurvey('beta')" class="group w-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 active:scale-95 rounded-2xl p-6 shadow-lg border-2 border-gray-200 dark:border-gray-700 transition-all duration-200">
        <div class="flex items-center justify-between">
          <div class="text-left">
            <h3 class="text-xl font-bold mb-1">Beta Testing</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">User experience evaluation</p>
          </div>
          <span class="material-symbols-outlined text-4xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- CONSENT SCREEN -->
<div id="consent-screen" class="screen flex-col min-h-screen p-6">
  <div class="flex items-center mb-6">
    <button onclick="goToHome()" class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
      <span class="material-symbols-outlined text-3xl">arrow_back</span>
    </button>
    <h1 class="text-2xl font-bold ml-4">Data Privacy Consent</h1>
  </div>
  
  <div class="flex-1">
    <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-2xl p-6 mb-6">
      <p class="text-sm leading-relaxed">The researchers value the confidentiality of any data you have entrusted to us. We will use your given information for thesis purposes only.</p>
    </div>
    
    <div class="space-y-4">
      <label class="flex items-center p-5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
        <input type="radio" name="consent" value="agree" class="w-5 h-5 text-primary" onclick="document.getElementById('consent-agree-btn').disabled = false">
        <span class="ml-4 text-lg font-medium">I Agree</span>
      </label>
      
      <label class="flex items-center p-5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-red-400 transition-colors">
        <input type="radio" name="consent" value="disagree" class="w-5 h-5 text-red-500" onclick="document.getElementById('consent-agree-btn').disabled = true">
        <span class="ml-4 text-lg font-medium">I Disagree</span>
      </label>
    </div>
  </div>
  
  <button id="consent-agree-btn" disabled onclick="goToPersonalInfo()" class="w-full bg-primary text-white rounded-full py-4 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90 active:scale-95 transition-all">
    Continue
  </button>
</div>

<!-- PERSONAL INFO SCREEN -->
<div id="personal-info-screen" class="screen flex-col min-h-screen p-6">
  <div class="flex items-center mb-6">
    <button onclick="goToConsent()" class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
      <span class="material-symbols-outlined text-3xl">arrow_back</span>
    </button>
    <h1 class="text-2xl font-bold ml-4">Personal Information</h1>
  </div>
  
  <div class="flex-1 space-y-5">
    <div>
      <label class="block text-sm font-medium mb-2">Name (Optional)</label>
      <input type="text" id="respondent-name" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors" placeholder="Enter your name">
    </div>
    
    <div id="alpha-fields" style="display:none;">
      <label class="block text-sm font-medium mb-2">Profession / Designation</label>
      <input type="text" id="profession" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors" placeholder="Enter profession">
    </div>
    
    <div id="alpha-email-field" style="display:none;">
      <label class="block text-sm font-medium mb-2">Email</label>
      <input type="email" id="email" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors" placeholder="Enter email">
    </div>
    
    <div id="beta-fields" style="display:none;">
      <label class="block text-sm font-medium mb-3">Sex</label>
      <div class="flex gap-3">
        <label class="flex-1 flex items-center justify-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
          <input type="radio" name="sex" value="male" class="w-5 h-5 text-primary mr-3">
          <span class="font-medium">Male</span>
        </label>
        <label class="flex-1 flex items-center justify-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
          <input type="radio" name="sex" value="female" class="w-5 h-5 text-primary mr-3">
          <span class="font-medium">Female</span>
        </label>
      </div>
      
      <label class="block text-sm font-medium mt-5 mb-3">Age</label>
      <select id="age" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors">
        <option value="">Select age range</option>
        <option value="18-22">18 - 22 years old</option>
        <option value="23-27">23 - 27 years old</option>
        <option value="28-32">28 - 32 years old</option>
        <option value="33-39">33 - 39 years old</option>
      </select>
      
      <label class="block text-sm font-medium mt-5 mb-3">Category</label>
      <div class="space-y-3">
        <label class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
          <input type="radio" name="category" value="student" class="w-5 h-5 text-primary mr-3">
          <span class="font-medium">College Student</span>
        </label>
        <label class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
          <input type="radio" name="category" value="non-student" class="w-5 h-5 text-primary mr-3">
          <span class="font-medium">Non-Student Young Adult</span>
        </label>
      </div>
    </div>
  </div>
  
  <button onclick="goToMetricSelection()" class="w-full bg-primary text-white rounded-full py-4 font-bold text-lg hover:bg-primary/90 active:scale-95 transition-all mt-6">
    Start Survey
  </button>
</div>

<!-- METRIC SELECTION SCREEN -->
<div id="metric-screen" class="screen flex-col min-h-screen p-6">
  <div class="flex items-center justify-between mb-6">
    <button onclick="goToPersonalInfo()" class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
      <span class="material-symbols-outlined text-3xl">arrow_back</span>
    </button>
    <h1 id="metric-title" class="text-2xl font-bold">Select Metric</h1>
    <div class="w-10"></div>
  </div>
  
  <div id="metric-progress" class="mb-6">
    <div class="flex justify-between text-sm font-medium mb-2">
      <span>Progress</span>
      <span id="metric-progress-text">0 of 5</span>
    </div>
    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
      <div id="metric-progress-bar" class="h-full bg-primary transition-all duration-500" style="width: 0%"></div>
    </div>
  </div>
  
  <div id="metric-list" class="space-y-3 flex-1 overflow-y-auto pb-4">
    <!-- Dynamically populated -->
  </div>
</div>

<!-- ITEM SCORING SCREEN -->
<div id="scoring-screen" class="screen flex-col min-h-screen">
  <div class="sticky top-0 bg-background-light dark:bg-background-dark z-10 pb-4">
    <div class="flex items-center justify-between p-6 pb-4">
      <button onclick="goBackToMetrics()" class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
        <span class="material-symbols-outlined text-3xl">arrow_back</span>
      </button>
      <h1 id="scoring-metric-name" class="text-lg font-bold">Metric</h1>
      <div class="w-10"></div>
    </div>
    
    <div class="px-6">
      <div class="flex justify-between text-sm font-medium mb-2">
        <span id="scoring-progress-text">Question 1 of 5</span>
      </div>
      <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
        <div id="scoring-progress-bar" class="h-full bg-primary transition-all duration-500" style="width: 20%"></div>
      </div>
    </div>
  </div>
  
  <div class="flex-1 px-6 flex flex-col">
    <p id="scoring-question" class="text-xl font-bold leading-tight mb-8"></p>
    
    <div class="space-y-3 mb-8">
      <button onclick="selectScore(5)" class="score-btn w-full p-5 rounded-xl border-3 border-green-400 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 font-bold hover:bg-green-100 dark:hover:bg-green-900/30 active:scale-95 transition-all duration-200 flex items-center justify-between">
        <span>Strongly Agree</span>
        <span class="text-2xl font-bold">5</span>
      </button>
      <button onclick="selectScore(4)" class="score-btn w-full p-5 rounded-xl border-3 border-blue-400 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 font-bold hover:bg-blue-100 dark:hover:bg-blue-900/30 active:scale-95 transition-all duration-200 flex items-center justify-between">
        <span>Agree</span>
        <span class="text-2xl font-bold">4</span>
      </button>
      <button onclick="selectScore(3)" class="score-btn w-full p-5 rounded-xl border-3 border-gray-400 bg-gray-50 dark:bg-gray-700/20 text-gray-700 dark:text-gray-400 font-bold hover:bg-gray-100 dark:hover:bg-gray-700/30 active:scale-95 transition-all duration-200 flex items-center justify-between">
        <span>Neutral</span>
        <span class="text-2xl font-bold">3</span>
      </button>
      <button onclick="selectScore(2)" class="score-btn w-full p-5 rounded-xl border-3 border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 font-bold hover:bg-orange-100 dark:hover:bg-orange-900/30 active:scale-95 transition-all duration-200 flex items-center justify-between">
        <span>Disagree</span>
        <span class="text-2xl font-bold">2</span>
      </button>
      <button onclick="selectScore(1)" class="score-btn w-full p-5 rounded-xl border-3 border-red-400 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 font-bold hover:bg-red-100 dark:hover:bg-red-900/30 active:scale-95 transition-all duration-200 flex items-center justify-between">
        <span>Strongly Disagree</span>
        <span class="text-2xl font-bold">1</span>
      </button>
    </div>
  </div>
</div>

<!-- COMMENTS SCREEN -->
<div id="comments-screen" class="screen flex-col min-h-screen p-6">
  <div class="flex items-center mb-6">
    <button onclick="goBackToMetrics()" class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
      <span class="material-symbols-outlined text-3xl">arrow_back</span>
    </button>
    <h1 class="text-2xl font-bold ml-4">Final Step</h1>
  </div>
  
  <div class="flex-1">
    <label class="block text-lg font-bold mb-3">Comments and Recommendations</label>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Please share any technical observations, bug reports, or recommendations for improving the system.</p>
    <textarea id="comments" rows="8" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors resize-none" placeholder="Enter your comments here..."></textarea>
  </div>
  
  <button onclick="submitSurvey()" class="w-full bg-green-500 hover:bg-green-600 text-white rounded-full py-4 font-bold text-lg active:scale-95 transition-all mt-6">
    Submit Survey
  </button>
</div>

<!-- SUCCESS SCREEN -->
<div id="success-screen" class="screen flex-col min-h-screen p-6 items-center justify-center text-center">
  <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-6 animate-bounce">
    <span class="material-symbols-outlined text-white text-6xl">check</span>
  </div>
  <h1 class="text-3xl font-bold mb-3">Thank You!</h1>
  <p class="text-gray-600 dark:text-gray-400 mb-8">Your response has been recorded successfully.</p>
  <button onclick="resetSurvey()" class="bg-primary text-white rounded-full px-8 py-4 font-bold hover:bg-primary/90 active:scale-95 transition-all">
    Submit Another Response
  </button>
</div>

<!-- RESULTS TAB -->
<div id="results-tab" class="screen flex-col min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-6">Survey Results</h1>
  
  <div class="mb-4 flex gap-2">
    <select id="results-mode-select" onchange="updateResultsView()" class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none">
      <option value="">Select Testing Mode</option>
      <option value="alpha">Alpha Testing</option>
      <option value="beta">Beta Testing</option>
    </select>
    <button onclick="exportAllResults()" class="px-6 py-3 bg-primary text-white rounded-xl font-bold hover:bg-primary/90 active:scale-95 transition-all">
      <span class="material-symbols-outlined">download</span>
    </button>
  </div>
  
  <div id="results-content" class="space-y-4">
    <div class="text-center py-12 text-gray-500">
      <span class="material-symbols-outlined text-6xl mb-3">bar_chart</span>
      <p>Select a testing mode to view results</p>
    </div>
  </div>
</div>

</div>

<script>
const surveyData = {
  alpha: {
    title: "Alpha Testing",
    metrics: {
      usability: { name: "Usability", icon: "front_hand", items: ["The user interface is self-intuitive and user-friendly.", "The system flow is logical and easy to do transition between the system's functionalities.", "The error messages are clear, easy to understand, and facilitate solutions.", "The time required to load different components of the platform (e.g., chat window, booking page) is acceptable.", "The platform minimizes the number of steps required to perform key actions, such as scheduling an appointment."] },
      accessibility: { name: "Accessibility", icon: "accessibility_new", items: ["The system displays consistently across major web browsers (Chrome, Edge, Firefox, etc.).", "The system works properly on both desktop and mobile devices.", "The text size, color contrast, and font choices adhere to general web accessibility standards.", "The system is fully navigated using standard keyboard-only controls.", "The platform handles intermittent or low-bandwidth internet connections gracefully without crashing."] },
      effectiveness: { name: "Effectiveness", icon: "target", items: ["All core system features (e.g., registration, video consultation, scheduling) are fully functional without technical errors.", "The AI Companion facilitates the user toward the Professional Consultation Services when complex issues are detected (Safety Protocol).", "The system effectively stores and retrieves data (e.g., user profiles, consultation history) without corruption.", "The appointment scheduling and video consultation features function reliably from start to finish.", "The AI Companion's responses and information are clinically appropriate."] },
      security: { name: "Security & Compliance", icon: "verified_user", items: ["The platform provides clear and comprehensive information regarding data privacy and security policies.", "I am satisfied that the system design adheres to ethical standards for handling sensitive mental health data.", "The user authentication process (login/registration) is robust and protects user identity.", "The platform securely handles and encrypts sensitive mental health data during transmission and storage.", "The process for professionals to verify their credentials and join the platform is adequate and secure."] },
      maintainability: { name: "Maintainability", icon: "build", items: ["The codebase and technical structure appear organized and would be easy for a new developer to understand and maintain.", "The system uses appropriate technology and established standards to ensure long-term sustainability and future upgrades.", "The system design is modular, allowing individual components (e.g., AI chat, consultation module) to be updated independently.", "The system documentation is comprehensive and accurate to support future enhancement.", "The platform uses widely supported and up-to-date frameworks and libraries (e.g., Django) to ensure longevity."] }
    }
  },
  beta: {
    title: "Beta Testing",
    metrics: {
      engagement: { name: "Engagement", icon: "favorite", items: ["The AI Companion and self-help tools are interesting enough that I would want to continue using MindEase regularly.", "I found the interactive nature of the platform motivating for maintaining my mental well-being.", "I appreciate the format and delivery of the mental health information provided by the AI Companion.", "The platform's features and contents encourage me to regularly check in on my emotional well-being.", "The overall look and feel of MindEase makes me want to spend more time exploring its support tools."] },
      effectiveness: { name: "Effectiveness (Helpfulness)", icon: "health_and_safety", items: ["The guidance, support, and information provided by the AI Companion are helpful for my stress or anxiety.", "I believe the platform provides a valuable pathway to accessing mental health services.", "The platform's design makes it easy for me to identify when I need to escalate from the AI Companion to human consultation.", "I learned new strategies or gained helpful insights from using the AI Companion.", "The self-help tools and guided resources available on the platform are relevant to the challenges I face."] },
      satisfaction: { name: "Satisfaction", icon: "sentiment_satisfied", items: ["My overall experience with the MindEase platform met my expectations for a mental health support tool.", "I would recommend MindEase to someone who might need mental health support.", "The waiting time for scheduling a consultation with a professional was acceptable.", "The platform successfully created a sense of trust and confidentiality during my use.", "MindEase's integrated service provides more comprehensive support than using a stand-alone mental health application."] },
      usability: { name: "Usability (Interface Clarity)", icon: "touch_app", items: ["The platform is easy to understand, navigate, and requires little effort for me to use successfully.", "The visual design and user interface are appealing and made the experience pleasant.", "The icons, buttons, and navigation labels clearly indicate their function.", "I could easily switch between the AI chat feature and other parts of the platform without confusion.", "The platform provides sufficient guidance or help resources when I encounter a problem."] },
      accessibility: { name: "Accessibility (Barrier Mitigation)", icon: "accessible", items: ["The system's online nature significantly reduces the barriers I face in getting support.", "Using MindEase makes me feel less self-conscious or stigmatized than seeking traditional, face-to-face help.", "The platform saves me time and effort compared to trying to find a professional using traditional means.", "The platform's cost-free nature eliminates a major barrier to me seeking mental health support.", "I feel comfortable being completely honest about my mental state when using the AI Companion."] }
    }
  }
};

let currentMode, currentMetric, currentItemIndex, currentSession, allResponses = [];

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  setTimeout(() => document.getElementById(id).classList.add('active'), 50);
}

function showHomeTab() {
  document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-home').classList.add('active');
  showScreen('home-tab');
}

function showResultsTab() {
  document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-results').classList.add('active');
  showScreen('results-tab');
  loadResults();
}

function startSurvey(mode) {
  currentMode = mode;
  currentSession = { mode, timestamp: new Date().toISOString(), personalInfo: {}, responses: {} };
  
  if (mode === 'alpha') {
    document.getElementById('alpha-fields').style.display = 'block';
    document.getElementById('alpha-email-field').style.display = 'block';
    document.getElementById('beta-fields').style.display = 'none';
  } else {
    document.getElementById('alpha-fields').style.display = 'none';
    document.getElementById('alpha-email-field').style.display = 'none';
    document.getElementById('beta-fields').style.display = 'block';
  }
  
  showScreen('consent-screen');
}

function goToHome() { showScreen('home-tab'); }
function goToConsent() { showScreen('consent-screen'); }

function goToPersonalInfo() {
  const consent = document.querySelector('input[name="consent"]:checked');
  if (!consent || consent.value !== 'agree') {
    alert('Please agree to the data privacy consent to continue.');
    return;
  }
  currentSession.consent = 'agree';
  showScreen('personal-info-screen');
}

function goToMetricSelection() {
  const name = document.getElementById('respondent-name').value;
  currentSession.personalInfo.name = name;
  
  if (currentMode === 'alpha') {
    currentSession.personalInfo.profession = document.getElementById('profession').value;
    currentSession.personalInfo.email = document.getElementById('email').value;
  } else {
    const sex = document.querySelector('input[name="sex"]:checked');
    currentSession.personalInfo.sex = sex ? sex.value : '';
    currentSession.personalInfo.age = document.getElementById('age').value;
    const category = document.querySelector('input[name="category"]:checked');
    currentSession.personalInfo.category = category ? category.value : '';
  }
  
  renderMetricList();
  showScreen('metric-screen');
}

function renderMetricList() {
  const mode = surveyData[currentMode];
  document.getElementById('metric-title').textContent = mode.title;
  const list = document.getElementById('metric-list');
  list.innerHTML = '';
  
  let completed = 0;
  Object.keys(mode.metrics).forEach((key, idx) => {
    const metric = mode.metrics[key];
    const isComplete = currentSession.responses[key] && Object.keys(currentSession.responses[key]).length === 5;
    if (isComplete) completed++;
    
    const btn = document.createElement('button');
    btn.className = `w-full p-5 rounded-2xl border-2 transition-all duration-200 active:scale-95 animate-slide-in flex items-center gap-4 ${isComplete ? 'bg-green-50 dark:bg-green-900/20 border-green-400' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-primary'}`;
    btn.style.animationDelay = `${idx * 0.1}s`;
    btn.onclick = () => startMetricScoring(key);
    
    btn.innerHTML = `
      <div class="w-12 h-12 rounded-full ${isComplete ? 'bg-green-500 text-white' : 'bg-primary/20 text-primary'} flex items-center justify-center">
        <span class="material-symbols-outlined text-2xl">${isComplete ? 'check' : metric.icon}</span>
      </div>
      <div class="flex-1 text-left">
        <h3 class="font-bold text-lg">${metric.name}</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">${isComplete ? 'Completed' : '5 questions'}</p>
      </div>
      <span class="material-symbols-outlined text-2xl text-gray-400">arrow_forward_ios</span>
    `;
    
    list.appendChild(btn);
  });
  
  document.getElementById('metric-progress-text').textContent = `${completed} of 5`;
  document.getElementById('metric-progress-bar').style.width = `${(completed / 5) * 100}%`;
}

function startMetricScoring(metricKey) {
  currentMetric = metricKey;
  currentItemIndex = 0;
  if (!currentSession.responses[metricKey]) {
    currentSession.responses[metricKey] = {};
  }
  showScoringScreen();
}

function showScoringScreen() {
  const mode = surveyData[currentMode];
  const metric = mode.metrics[currentMetric];
  
  document.getElementById('scoring-metric-name').textContent = metric.name;
  document.getElementById('scoring-progress-text').textContent = `Question ${currentItemIndex + 1} of 5`;
  document.getElementById('scoring-progress-bar').style.width = `${((currentItemIndex + 1) / 5) * 100}%`;
  document.getElementById('scoring-question').textContent = metric.items[currentItemIndex];
  
  showScreen('scoring-screen');
}

function selectScore(score) {
  const btn = event.target.closest('button');
  btn.style.transform = 'scale(0.9)';
  
  setTimeout(() => {
    btn.style.transform = '';
    currentSession.responses[currentMetric][currentItemIndex] = score;
    
    if (currentItemIndex < 4) {
      currentItemIndex++;
      showScoringScreen();
    } else {
      checkAllMetricsComplete();
    }
  }, 200);
}

function checkAllMetricsComplete() {
  const mode = surveyData[currentMode];
  const allComplete = Object.keys(mode.metrics).every(key => 
    currentSession.responses[key] && Object.keys(currentSession.responses[key]).length === 5
  );
  
  if (allComplete) {
    showScreen('comments-screen');
  } else {
    renderMetricList();
    showScreen('metric-screen');
  }
}

function goBackToMetrics() {
  renderMetricList();
  showScreen('metric-screen');
}

function submitSurvey() {
  currentSession.comments = document.getElementById('comments').value;
  
  const stored = localStorage.getItem('mindease-responses');
  allResponses = stored ? JSON.parse(stored) : [];
  allResponses.push(currentSession);
  localStorage.setItem('mindease-responses', JSON.stringify(allResponses));
  
  showScreen('success-screen');
}

function resetSurvey() {
  currentSession = null;
  currentMode = null;
  currentMetric = null;
  currentItemIndex = 0;
  
  document.getElementById('respondent-name').value = '';
  document.getElementById('comments').value = '';
  document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
  document.getElementById('consent-agree-btn').disabled = true;
  
  showHomeTab();
}

function loadResults() {
  const stored = localStorage.getItem('mindease-responses');
  allResponses = stored ? JSON.parse(stored) : [];
  updateResultsView();
}

function updateResultsView() {
  const mode = document.getElementById('results-mode-select').value;
  const container = document.getElementById('results-content');
  
  if (!mode) {
    container.innerHTML = '<div class="text-center py-12 text-gray-500"><span class="material-symbols-outlined text-6xl mb-3">bar_chart</span><p>Select a testing mode to view results</p></div>';
    return;
  }
  
  const modeResponses = allResponses.filter(r => r.mode === mode);
  
  if (modeResponses.length === 0) {
    container.innerHTML = '<div class="text-center py-12 text-gray-500"><span class="material-symbols-outlined text-6xl mb-3">inbox</span><p>No responses yet</p></div>';
    return;
  }
  
  const modeData = surveyData[mode];
  container.innerHTML = `
    <div class="bg-primary/10 border-2 border-primary rounded-2xl p-5 mb-4">
      <h3 class="text-xl font-bold">${modeData.title}</h3>
      <p class="text-primary font-bold text-2xl mt-1">${modeResponses.length} Total Responses</p>
    </div>
  `;
  
  Object.keys(modeData.metrics).forEach(metricKey => {
    const metric = modeData.metrics[metricKey];
    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-gray-800 rounded-2xl p-5 border-2 border-gray-200 dark:border-gray-700';
    
    let html = `<h3 class="text-xl font-bold mb-4 flex items-center gap-2">
      <span class="material-symbols-outlined text-primary">${metric.icon}</span>
      ${metric.name}
    </h3>`;
    
    metric.items.forEach((item, itemIdx) => {
      const scores = {1:0, 2:0, 3:0, 4:0, 5:0};
      let total = 0, sum = 0;
      
      modeResponses.forEach(resp => {
        if (resp.responses[metricKey] && resp.responses[metricKey][itemIdx]) {
          const score = resp.responses[metricKey][itemIdx];
          scores[score]++;
          sum += score;
          total++;
        }
      });
      
      const avg = total > 0 ? (sum / total).toFixed(1) : '0.0';
      
      html += `
        <div class="mb-4 pb-4 ${itemIdx < metric.items.length - 1 ? 'border-b border-gray-200 dark:border-gray-700' : ''}">
          <p class="font-medium text-sm mb-2">${itemIdx + 1}. ${item}</p>
          <div class="flex items-center gap-2 mb-2">
            <div class="flex-1 flex gap-1 h-8">
              ${[1,2,3,4,5].map(s => {
                const pct = total > 0 ? (scores[s] / total) * 100 : 0;
                const colors = ['bg-red-400', 'bg-orange-400', 'bg-gray-400', 'bg-blue-400', 'bg-green-400'];
                return `<div class="${colors[s-1]}" style="width: ${pct}%" title="Score ${s}: ${scores[s]} (${pct.toFixed(0)}%)"></div>`;
              }).join('')}
            </div>
            <div class="text-right min-w-16">
              <p class="text-2xl font-bold text-primary">${avg}</p>
              <p class="text-xs text-gray-500">${total} resp.</p>
            </div>
          </div>
          <div class="flex gap-2 text-xs">
            ${[1,2,3,4,5].map(s => `<span class="flex-1 text-center">${s}:${scores[s]}</span>`).join('')}
          </div>
        </div>
      `;
    });
    
    card.innerHTML = html;
    container.appendChild(card);
  });
}

function exportAllResults() {
  const mode = document.getElementById('results-mode-select').value;
  if (!mode) {
    alert('Please select a testing mode first');
    return;
  }
  
  const modeResponses = allResponses.filter(r => r.mode === mode);
  if (modeResponses.length === 0) {
    alert('No responses to export');
    return;
  }
  
  const modeData = surveyData[mode];
  let csv = 'Timestamp,Name,';
  
  if (mode === 'alpha') {
    csv += 'Profession,Email,';
  } else {
    csv += 'Sex,Age,Category,';
  }
  
  Object.keys(modeData.metrics).forEach(metricKey => {
    const metric = modeData.metrics[metricKey];
    metric.items.forEach((item, idx) => {
      csv += `"${metric.name} - Q${idx + 1}",`;
    });
  });
  
  csv += 'Comments\n';
  
  modeResponses.forEach(resp => {
    csv += `"${resp.timestamp}","${resp.personalInfo.name || ''}",`;
    
    if (mode === 'alpha') {
      csv += `"${resp.personalInfo.profession || '"}","${resp.personalInfo.email || ''}",`;
    } else {
      csv += `"${resp.personalInfo.sex || ''}","${resp.personalInfo.age || ''}","${resp.personalInfo.category || ''}",`;
    }
    
    Object.keys(modeData.metrics).forEach(metricKey => {
      const metric = modeData.metrics[metricKey];
      metric.items.forEach((item, idx) => {
        const score = resp.responses[metricKey]?.[idx] || '';
        csv += `${score},`;
      });
    });
    
    csv += `"${(resp.comments || '').replace(/"/g, '""')}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `mindease-${mode}-results-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

window.onload = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('Service Worker registered'))
      .catch(err => console.log('Service Worker failed:', err));
  }
  
  const stored = localStorage.getItem('mindease-responses');
  allResponses = stored ? JSON.parse(stored) : [];
};
</script>

</body>
</html>
