<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="MindEase" />
  <meta name="theme-color" content="#4169E1" />
  <title>MindEase Testing Portal</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="manifest" href="./manifest.json">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA5JhjcF6dWo2tCz2cWGw43hKxmPGQw-M4",
      authDomain: "mindease-survey-tool.firebaseapp.com",
      projectId: "mindease-survey-tool",
      storageBucket: "mindease-survey-tool.firebasestorage.app",
      messagingSenderId: "27120663580",
      appId: "1:27120663580:web:95b679794f4f2e8422b3d9",
      measurementId: "G-LZNVL98LD9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize Cloud Firestore
    const db = firebase.firestore();
  </script>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4169E1",
            "background-light": "#FAFBFC",
            "background-dark": "#101214",
            "text-light": "#343A40",
            "text-dark": "#E9ECEF",
          },
          fontFamily: {
            "display": ["Manrope", "sans-serif"]
          },
        },
      },
    }
  </script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      background: #FAFBFC;
    }

    .dark body {
      background: #101214;
    }

    .screen {
      display: none;
      opacity: 0;
    }

    .screen.active {
      display: flex;
      opacity: 1;
    }

    .fit-viewport {
      min-height: calc(100vh - 5rem);
      max-height: calc(100vh - 5rem);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-slide-in {
      animation: slideInRight 0.5s ease forwards;
      opacity: 0;
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background: #4169E1;
      color: white;
    }

    #results-filter-select {
      min-width: 180px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    /* Fix for consistent border thickness on focus */
    input[type="text"]:focus,
    input[type="email"]:focus,
    select:focus,
    textarea:focus {
      --tw-ring-offset-width: 0px;
      --tw-ring-width: 0px;
      box-shadow: none !important;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4169E1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="font-display">

  <nav
    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 z-50 safe-area-inset">
    <div class="flex max-w-md mx-auto">
      <button type="button" onclick="showHomeTab()" id="tab-home"
        class="tab-button active flex-1 flex flex-col items-center py-3 px-4">
        <span class="material-symbols-outlined text-2xl mb-1">home</span>
        <span class="text-xs font-medium">Home</span>
      </button>
      <button type="button" onclick="showResultsTab()" id="tab-results"
        class="tab-button flex-1 flex flex-col items-center py-3 px-4 text-gray-600 dark:text-gray-400">
        <span class="material-symbols-outlined text-2xl mb-1">bar_chart</span>
        <span class="text-xs font-medium">Results</span>
      </button>
    </div>
  </nav>

  <div class="pb-20 max-w-md mx-auto">

    <div id="home-tab" class="screen active flex-col fit-viewport p-6">
      <div class="flex-1 flex flex-col items-center justify-center max-w-md mx-auto w-full">
        <div class="flex items-center justify-center h-20 w-20 bg-primary/20 rounded-2xl mb-6">
          <span class="material-symbols-outlined text-primary text-5xl">science</span>
        </div>
        <h1 class="text-3xl font-bold text-center mb-3">MindEase Testing</h1>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-12">Select your testing group</p>

        <div class="w-full space-y-4">
          <button type="button" onclick="startSurvey('alpha')"
            class="group w-full bg-primary hover:bg-primary/90 active:scale-95 text-white rounded-2xl p-6 shadow-lg transition-all duration-200">
            <div class="flex items-center justify-between">
              <div class="text-left">
                <h3 class="text-xl font-bold mb-1">Alpha Testing</h3>
                <p class="text-white/80 text-sm">System validation & technical</p>
              </div>
              <span
                class="material-symbols-outlined text-4xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </div>
          </button>

          <button type="button" onclick="startSurvey('beta')"
            class="group w-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 active:scale-95 rounded-2xl p-6 shadow-lg border-2 border-gray-200 dark:border-gray-700 transition-all duration-200">
            <div class="flex items-center justify-between">
              <div class="text-left">
                <h3 class="text-xl font-bold mb-1">Beta Testing</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm">User experience evaluation</p>
              </div>
              <span
                class="material-symbols-outlined text-4xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <div id="consent-screen" class="screen flex-col fit-viewport p-5 overflow-hidden">
      <div class="flex items-center mb-3 flex-shrink-0">
        <button type="button" onclick="goToHome()"
          class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
          <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold ml-3">Data Privacy Consent</h1>
      </div>

      <div class="flex-1 flex flex-col justify-center min-h-0">
        <div
          class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-4 text-sm leading-relaxed">
          The researchers value the confidentiality of any data you have entrusted to us. We will use your given
          information for thesis purposes only.
        </div>

        <div class="space-y-3">
          <label
            class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
            <input type="radio" name="consent" value="agree" class="w-5 h-5 text-primary"
              onchange="document.getElementById('consent-agree-btn').disabled = false">
            <span class="ml-3 text-sm font-medium">I Agree</span>
          </label>

          <label
            class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-red-400 transition-colors">
            <input type="radio" name="consent" value="disagree" class="w-5 h-5 text-red-500"
              onchange="document.getElementById('consent-agree-btn').disabled = true">
            <span class="ml-3 text-sm font-medium">I Disagree</span>
          </label>
        </div>
      </div>

      <button type="button" id="consent-agree-btn" disabled onclick="goToPersonalInfo()"
        class="w-full bg-primary text-white rounded-full py-3 font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90 active:scale-95 transition-all flex-shrink-0 mt-4">
        Continue
      </button>
    </div>

    <div id="personal-info-screen" class="screen flex-col fit-viewport p-5 overflow-hidden">
      <div class="flex items-center mb-3 flex-shrink-0">
        <button type="button" onclick="goToConsent()"
          class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
          <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold ml-3">Personal Information</h1>
      </div>

      <div class="flex-1 flex flex-col justify-center space-y-4 min-h-0">
        <div>
          <label class="block text-xs font-medium mb-1">Name (Optional)</label>
          <input type="text" id="respondent-name"
            class="w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors"
            placeholder="Enter your name">
        </div>

        <div id="alpha-fields" style="display:none;">
          <label class="block text-xs font-medium mb-1">Profession / Designation <span
              class="text-red-500">*</span></label>
          <input type="text" id="profession" required
            class="w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors"
            placeholder="Enter profession" oninput="validatePersonalInfo()">
        </div>

        <div id="alpha-email-field" style="display:none;">
          <label class="block text-xs font-medium mb-1">Email <span class="text-red-500">*</span></label>
          <input type="email" id="email" required
            class="w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors"
            placeholder="Enter email" oninput="validatePersonalInfo()">
        </div>

        <div id="beta-fields" style="display:none;">
          <label class="block text-xs font-medium mb-1">Sex <span class="text-red-500">*</span></label>
          <div class="flex gap-2">
            <label
              class="flex-1 flex items-center justify-center p-2.5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
              <input type="radio" name="sex" value="male" class="w-4 h-4 text-primary mr-2"
                onchange="validatePersonalInfo()">
              <span class="font-medium text-xs">Male</span>
            </label>
            <label
              class="flex-1 flex items-center justify-center p-2.5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
              <input type="radio" name="sex" value="female" class="w-4 h-4 text-primary mr-2"
                onchange="validatePersonalInfo()">
              <span class="font-medium text-xs">Female</span>
            </label>
          </div>

          <label class="block text-xs font-medium mt-3 mb-1">Age <span class="text-red-500">*</span></label>
          <select id="age" required
            class="w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors"
            onchange="validatePersonalInfo()">
            <option value="">Select age range</option>
            <option value="18-22">18 - 22 years old</option>
            <option value="23-27">23 - 27 years old</option>
            <option value="28-32">28 - 32 years old</option>
            <option value="33-39">33 - 39 years old</option>
          </select>

          <label class="block text-xs font-medium mt-3 mb-1">Category <span class="text-red-500">*</span></label>
          <div class="space-y-2">
            <label
              class="flex items-center p-2.5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
              <input type="radio" name="category" value="student" class="w-4 h-4 text-primary mr-3"
                onchange="validatePersonalInfo()">
              <span class="font-medium text-xs">College Student</span>
            </label>
            <label
              class="flex items-center p-2.5 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-colors">
              <input type="radio" name="category" value="non-student" class="w-4 h-4 text-primary mr-3"
                onchange="validatePersonalInfo()">
              <span class="font-medium text-xs">Non-Student Young Adult</span>
            </label>
          </div>
        </div>
      </div>

      <button type="button" id="start-survey-btn" disabled onclick="goToMetricSelection()"
        class="w-full bg-primary text-white rounded-full py-3 font-bold text-sm hover:bg-primary/90 active:scale-95 transition-all flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
        Start Survey
      </button>
    </div>

    <div id="metric-screen" class="screen flex-col fit-viewport p-5 overflow-hidden">
      <div class="flex items-center justify-between mb-3 flex-shrink-0">
        <button type="button" onclick="goToPersonalInfo()"
          class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
          <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </button>
        <h1 id="metric-title" class="text-lg font-bold">Select Metric</h1>
        <div class="w-10"></div>
      </div>

      <div id="metric-progress" class="mb-4 flex-shrink-0">
        <div class="flex justify-between text-xs font-medium mb-2">
          <span>Progress</span>
          <span id="metric-progress-text">0 of 5</span>
        </div>
        <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div id="metric-progress-bar" class="h-full bg-primary transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <div id="metric-list" class="space-y-3 flex-1 flex flex-col justify-center min-h-0">
      </div>
    </div>

    <div id="scoring-screen" class="screen flex-col fit-viewport overflow-hidden">
      <div class="bg-background-light dark:bg-background-dark pb-3 flex-shrink-0">
        <div class="flex items-center justify-between p-5 pb-2">
          <button type="button" onclick="goBackToMetrics()"
            class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
            <span class="material-symbols-outlined text-2xl">arrow_back</span>
          </button>
          <h1 id="scoring-metric-name" class="text-base font-bold">Metric</h1>
          <div class="w-10"></div>
        </div>

        <div class="px-5">
          <div class="flex justify-between text-xs font-medium mb-2">
            <span id="scoring-progress-text">Question 1 of 5</span>
          </div>
          <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div id="scoring-progress-bar" class="h-full bg-primary transition-all duration-500" style="width: 20%">
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1 px-5 flex flex-col justify-center min-h-0">
        <p id="scoring-question" class="text-base font-bold leading-tight mb-6"></p>

        <div class="space-y-3">
          <button type="button" onclick="selectScore(5)" data-score="5"
            class="score-btn w-full p-3 rounded-xl border-3 border-green-400 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 font-bold hover:bg-green-100 dark:hover:bg-green-900/30 transition-all duration-200 flex items-center justify-between">
            <span class="text-xs">Strongly Agree</span>
            <span class="text-lg font-bold">5</span>
          </button>
          <button type="button" onclick="selectScore(4)" data-score="4"
            class="score-btn w-full p-3 rounded-xl border-3 border-blue-400 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 font-bold hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all duration-200 flex items-center justify-between">
            <span class="text-xs">Agree</span>
            <span class="text-lg font-bold">4</span>
          </button>
          <button type="button" onclick="selectScore(3)" data-score="3"
            class="score-btn w-full p-3 rounded-xl border-3 border-gray-400 bg-gray-100 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 flex items-center justify-between">
            <span class="text-xs">Neutral</span>
            <span class="text-lg font-bold">3</span>
          </button>
          <button type="button" onclick="selectScore(2)" data-score="2"
            class="score-btn w-full p-3 rounded-xl border-3 border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 font-bold hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-all duration-200 flex items-center justify-between">
            <span class="text-xs">Disagree</span>
            <span class="text-lg font-bold">2</span>
          </button>
          <button type="button" onclick="selectScore(1)" data-score="1"
            class="score-btn w-full p-3 rounded-xl border-3 border-red-400 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 font-bold hover:bg-red-100 dark:hover:bg-red-900/30 transition-all duration-200 flex items-center justify-between">
            <span class="text-xs">Strongly Disagree</span>
            <span class="text-lg font-bold">1</span>
          </button>
        </div>
      </div>

      <div
        class="bg-background-light dark:bg-background-dark border-t border-gray-200 dark:border-gray-700 p-4 flex-shrink-0">
        <div class="flex gap-2 max-w-md mx-auto">
          <button type="button" id="prev-question-btn" onclick="previousQuestion()"
            class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl py-2.5 font-bold hover:bg-gray-300 dark:hover:bg-gray-600 active:scale-95 transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-lg">arrow_back</span>
            <span class="text-xs">Back</span>
          </button>
          <button type="button" id="next-question-btn" onclick="nextQuestion()" disabled
            class="flex-1 bg-primary text-white rounded-xl py-2.5 font-bold hover:bg-primary/90 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span class="text-xs">Next</span>
            <span class="material-symbols-outlined text-lg">arrow_forward</span>
          </button>
        </div>
      </div>
    </div>

    <div id="comments-screen" class="screen flex-col fit-viewport p-5 overflow-hidden">
      <div class="flex items-center mb-3 flex-shrink-0">
        <button type="button" onclick="goBackToMetrics()"
          class="p-2 -ml-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
          <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold ml-3">Final Step</h1>
      </div>

      <div class="flex-1 flex flex-col justify-center min-h-0">
        <label class="block text-sm font-bold mb-2">Comments and Recommendations <span
            class="text-red-500">*</span></label>
        <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Please share any technical observations, bug reports,
          or recommendations for improving the system.</p>
        <textarea id="comments" rows="10" required
          class="w-full px-3 py-2.5 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none transition-colors resize-none"
          placeholder="Enter your comments here..." oninput="validateComments()"></textarea>
      </div>

      <button type="button" id="submit-survey-btn" disabled onclick="submitSurvey()"
        class="w-full bg-green-500 hover:bg-green-600 text-white rounded-full py-3 font-bold text-sm active:scale-95 transition-all mt-4 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
        Submit Survey
      </button>
    </div>

    <div id="success-screen" class="screen flex-col fit-viewport p-5 items-center justify-center text-center">
      <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-6 animate-bounce">
        <span class="material-symbols-outlined text-white text-6xl">check</span>
      </div>
      <h1 class="text-3xl font-bold mb-3">Thank You!</h1>
      <p class="text-gray-600 dark:text-gray-400 mb-8">Your response has been recorded successfully.</p>
      <button type="button" onclick="resetSurvey()"
        class="bg-primary text-white rounded-full px-8 py-4 font-bold hover:bg-primary/90 active:scale-95 transition-all">
        Submit Another Response
      </button>
    </div>

    <div id="results-tab" class="screen flex-col fit-viewport p-5 overflow-y-auto">
      <h1 class="text-xl font-bold mb-4 flex-shrink-0">Survey Results</h1>

      <div class="space-y-3 mb-4 flex-shrink-0">
        <div class="flex gap-2">
          <select id="results-mode-select" onchange="updateResultsView()"
            class="flex-1 px-3 py-2.5 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary outline-none appearance-none">
            <option value="">Select Testing Mode</option>
            <option value="alpha">Alpha Testing</option>
            <option value="beta">Beta Testing</option>
          </select>
        </div>

        <div class="flex gap-2">
          <select id="results-filter-select" onchange="updateResultsView()" disabled
            class="flex-1 px-3 py-2.5 text-sm rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 focus:border-primary outline-none appearance-none">
            <option value="all">All Metrics & Comments</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button type="button" onclick="exportAllResults()"
            class="flex-1 px-3 py-2.5 text-sm bg-primary text-white rounded-xl font-bold hover:bg-primary/90 active:scale-95 transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">download</span>
            <span>Export CSV</span>
          </button>
          <button type="button" onclick="clearDataPrompt()"
            class="flex-1 px-3 py-2.5 text-sm bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 active:scale-95 transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">delete</span>
            <span>Clear Data</span>
          </button>
        </div>
      </div>

      <div id="results-content" class="space-y-4 flex-1 overflow-y-auto">
        <div class="text-center py-12 text-gray-500">
          <span class="material-symbols-outlined text-6xl mb-3">bar_chart</span>
          <p>Select a testing mode to view results</p>
        </div>
      </div>
    </div>

    <div id="clear-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
      style="display: none;">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
        <div class="flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full mx-auto mb-4">
          <span class="material-symbols-outlined text-red-500 text-4xl">warning</span>
        </div>
        <h2 class="text-xl font-bold text-center mb-2">Clear Survey Data?</h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">This action cannot be undone. Select what to clear:
        </p>

        <div class="space-y-3 mb-6">
          <button type="button" onclick="clearData('alpha')"
            class="w-full bg-red-500 hover:bg-red-600 text-white rounded-xl py-3 font-bold active:scale-95 transition-all">
            Clear Alpha Testing Data
          </button>
          <button type="button" onclick="clearData('beta')"
            class="w-full bg-red-500 hover:bg-red-600 text-white rounded-xl py-3 font-bold active:scale-95 transition-all">
            Clear Beta Testing Data
          </button>
          <button type="button" onclick="clearData('all')"
            class="w-full bg-red-600 hover:bg-red-700 text-white rounded-xl py-3 font-bold active:scale-95 transition-all">
            Clear ALL Data
          </button>
        </div>

        <button type="button" onclick="closeClearModal()"
          class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl py-3 font-bold hover:bg-gray-300 dark:hover:bg-gray-600 active:scale-95 transition-all">
          Cancel
        </button>
      </div>
    </div>

  </div>

  <script>
    let currentScreen = 'home-tab';
    const SESSION_KEY = 'mindease-current-session';

    function saveSessionState() {
      if (currentSession) {
        localStorage.setItem(SESSION_KEY, JSON.stringify({
          session: currentSession,
          screen: currentScreen,
          mode: currentMode,
          metric: currentMetric,
          itemIndex: currentItemIndex
        }));
      }
    }

    function loadSessionState() {
      const saved = localStorage.getItem(SESSION_KEY);
      if (saved) {
        try {
          const state = JSON.parse(saved);
          currentSession = state.session;
          currentMode = state.mode;
          currentMetric = state.metric;
          currentItemIndex = state.itemIndex;
          currentScreen = state.screen;

          // Restore UI state based on saved screen
          if (currentScreen !== 'home-tab' && currentScreen !== 'results-tab') {
            if (currentMode === 'alpha') {
              document.getElementById('alpha-fields').style.display = 'block';
              document.getElementById('alpha-email-field').style.display = 'block';
              document.getElementById('beta-fields').style.display = 'none';
            } else {
              document.getElementById('alpha-fields').style.display = 'none';
              document.getElementById('alpha-email-field').style.display = 'none';
              document.getElementById('beta-fields').style.display = 'block';
            }

            // Restore form values
            if (currentSession.personalInfo) {
              if (currentSession.personalInfo.name) {
                document.getElementById('respondent-name').value = currentSession.personalInfo.name;
              }
              if (currentMode === 'alpha') {
                if (currentSession.personalInfo.profession) {
                  document.getElementById('profession').value = currentSession.personalInfo.profession;
                }
                if (currentSession.personalInfo.email) {
                  document.getElementById('email').value = currentSession.personalInfo.email;
                }
              } else {
                if (currentSession.personalInfo.sex) {
                  document.querySelector(`input[name="sex"][value="${currentSession.personalInfo.sex}"]`).checked = true;
                }
                if (currentSession.personalInfo.age) {
                  document.getElementById('age').value = currentSession.personalInfo.age;
                }
                if (currentSession.personalInfo.category) {
                  document.querySelector(`input[name="category"][value="${currentSession.personalInfo.category}"]`).checked = true;
                }
              }
            }

            // Restore consent
            if (currentSession.consent) {
              const consentRadio = document.querySelector(`input[name="consent"][value="${currentSession.consent}"]`);
              if (consentRadio) consentRadio.checked = true;
              document.getElementById('consent-agree-btn').disabled = currentSession.consent !== 'agree';
            }
          }

          return true;
        } catch (e) {
          console.error('Failed to restore session:', e);
          return false;
        }
      }
      return false;
    }

    function clearSessionState() {
      localStorage.removeItem(SESSION_KEY);
    }

    function goToHome() {
      showScreen('home-tab');
      currentScreen = 'home-tab';
      saveSessionState();
    }

    function goToConsent() {
      showScreen('consent-screen');
      currentScreen = 'consent-screen';
      saveSessionState();
    }

    function goToPersonalInfo() {
      const consent = document.querySelector('input[name="consent"]:checked');
      if (!consent || consent.value !== 'agree') {
        alert('Please agree to the data privacy consent to continue.');
        return;
      }
      currentSession.consent = 'agree';
      showScreen('personal-info-screen');
      currentScreen = 'personal-info-screen';
      saveSessionState();
      setTimeout(() => validatePersonalInfo(), 100);
    }

    const surveyData = {
      alpha: {
        title: "Alpha Testing",
        metrics: {
          usability: { name: "Usability", icon: "front_hand", items: ["The user interface is self-intuitive and user-friendly.", "The system flow is logical and easy to do transition between the system's functionalities.", "The error messages are clear, easy to understand, and facilitate solutions.", "The time required to load different components of the platform (e.g., chat window, booking page) is acceptable.", "The platform minimizes the number of steps required to perform key actions, such as scheduling an appointment."] },
          accessibility: { name: "Accessibility", icon: "accessibility_new", items: ["The system displays consistently across major web browsers (Chrome, Edge, Firefox, etc.).", "The system works properly on both desktop and mobile devices.", "The text size, color contrast, and font choices adhere to general web accessibility standards.", "The system is fully navigated using standard keyboard-only controls.", "The platform handles intermittent or low-bandwidth internet connections gracefully without crashing."] },
          effectiveness: { name: "Effectiveness", icon: "target", items: ["All core system features (e.g., registration, video consultation, scheduling) are fully functional without technical errors.", "The AI Companion facilitates the user toward the Professional Consultation Services when complex issues are detected (Safety Protocol).", "The system effectively stores and retrieves data (e.g., user profiles, consultation history) without corruption.", "The appointment scheduling and video consultation features function reliably from start to finish.", "The AI Companion's responses and information are clinically appropriate."] },
          security: { name: "Security & Compliance", icon: "verified_user", items: ["The platform provides clear and comprehensive information regarding data privacy and security policies.", "I am satisfied that the system design adheres to ethical standards for handling sensitive mental health data.", "The user authentication process (login/registration) is robust and protects user identity.", "The platform securely handles and encrypts sensitive mental health data during transmission and storage.", "The process for professionals to verify their credentials and join the platform is adequate and secure."] },
          maintainability: { name: "Maintainability", icon: "build", items: ["The codebase and technical structure appear organized and would be easy for a new developer to understand and maintain.", "The system uses appropriate technology and established standards to ensure long-term sustainability and future upgrades.", "The system design is modular, allowing individual components (e.g., AI chat, consultation module) to be updated independently.", "The system documentation is comprehensive and accurate to support future enhancement.", "The platform uses widely supported and up-to-date frameworks and libraries (e.g., Django) to ensure longevity."] }
        }
      },
      beta: {
        title: "Beta Testing",
        metrics: {
          engagement: { name: "Engagement", icon: "favorite", items: ["The AI Companion and self-help tools are interesting enough that I would want to continue using MindEase regularly.", "I found the interactive nature of the platform motivating for maintaining my mental well-being.", "I appreciate the format and delivery of the mental health information provided by the AI Companion.", "The platform's features and contents encourage me to regularly check in on my emotional well-being.", "The overall look and feel of MindEase makes me want to spend more time exploring its support tools."] },
          effectiveness: { name: "Effectiveness (Helpfulness)", icon: "health_and_safety", items: ["The guidance, support, and information provided by the AI Companion are helpful for my stress or anxiety.", "I believe the platform provides a valuable pathway to accessing mental health services.", "The platform's design makes it easy for me to identify when I need to escalate from the AI Companion to human consultation.", "I learned new strategies or gained helpful insights from using the AI Companion.", "The self-help tools and guided resources available on the platform are relevant to the challenges I face."] },
          satisfaction: { name: "Satisfaction", icon: "sentiment_satisfied", items: ["My overall experience with the MindEase platform met my expectations for a mental health support tool.", "I would recommend MindEase to someone who might need mental health support.", "The waiting time for scheduling a consultation with a professional was acceptable.", "The platform successfully created a sense of trust and confidentiality during my use.", "MindEase's integrated service provides more comprehensive support than using a stand-alone mental health application."] },
          usability: { name: "Usability (Interface Clarity)", icon: "touch_app", items: ["The platform is easy to understand, navigate, and requires little effort for me to use successfully.", "The visual design and user interface are appealing and made the experience pleasant.", "The icons, buttons, and navigation labels clearly indicate their function.", "I could easily switch between the AI chat feature and other parts of the platform without confusion.", "The platform provides sufficient guidance or help resources when I encounter a problem."] },
          accessibility: { name: "Accessibility (Barrier Mitigation)", icon: "accessible", items: ["The system's online nature significantly reduces the barriers I face in getting support.", "Using MindEase makes me feel less self-conscious or stigmatized than seeking traditional, face-to-face help.", "The platform saves me time and effort compared to trying to find a professional using traditional means.", "The platform's cost-free nature eliminates a major barrier to me seeking mental health support.", "I feel comfortable being completely honest about my mental state when using the AI Companion."] }
        }
      }
    };

    let currentMode, currentMetric, currentItemIndex, currentSession, allResponses = [];

    function buildFilterOptions() {
      const modeSelect = document.getElementById('results-mode-select');
      const filterSelect = document.getElementById('results-filter-select');
      const mode = modeSelect.value;

      const currentValue = filterSelect.value;

      if (!mode) {
        filterSelect.innerHTML = '<option value="all">All Metrics & Comments</option>';
        filterSelect.disabled = true;
        filterSelect.classList.remove('bg-white', 'dark:bg-gray-800');
        filterSelect.classList.add('bg-gray-100', 'dark:bg-gray-700');
        return;
      }

      filterSelect.disabled = false;
      filterSelect.classList.remove('bg-gray-100', 'dark:bg-gray-700');
      filterSelect.classList.add('bg-white', 'dark:bg-gray-800');

      const modeData = surveyData[mode];
      let html = '<option value="all">All Metrics & Comments</option>';

      Object.keys(modeData.metrics).forEach(metricKey => {
        const metric = modeData.metrics[metricKey];
        html += `<option value="${metricKey}">${metric.name}</option>`;
      });

      html += '<option value="comments">Comments</option>';

      filterSelect.innerHTML = html;

      if (currentValue && filterSelect.querySelector(`option[value="${currentValue}"]`)) {
        filterSelect.value = currentValue;
      } else {
        filterSelect.value = 'all';
      }
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
      });
      setTimeout(() => {
        const screen = document.getElementById(id);
        screen.style.display = 'flex';
        setTimeout(() => screen.classList.add('active'), 10);
      }, 50);
    }

    function showHomeTab() {
      document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-home').classList.add('active');

      if (currentSession && currentScreen !== 'home-tab' && currentScreen !== 'results-tab' && currentScreen !== 'success-screen') {
        showScreen(currentScreen);
      } else {
        showScreen('home-tab');
        currentScreen = 'home-tab';
      }
    }

    function showResultsTab() {
      document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-results').classList.add('active');
      showScreen('results-tab');
      loadResults();
    }

    function startSurvey(mode) {
      currentMode = mode;
      currentSession = { mode, timestamp: new Date().toISOString(), personalInfo: {}, responses: {} };

      if (mode === 'alpha') {
        document.getElementById('alpha-fields').style.display = 'block';
        document.getElementById('alpha-email-field').style.display = 'block';
        document.getElementById('beta-fields').style.display = 'none';
      } else {
        document.getElementById('alpha-fields').style.display = 'none';
        document.getElementById('alpha-email-field').style.display = 'none';
        document.getElementById('beta-fields').style.display = 'block';
      }

      document.getElementById('start-survey-btn').disabled = true;
      showScreen('consent-screen');
      currentScreen = 'consent-screen';
      saveSessionState();
    }

    function validatePersonalInfo() {
      let isValid = false;

      if (currentMode === 'alpha') {
        const profession = document.getElementById('profession').value.trim();
        const email = document.getElementById('email').value.trim();
        isValid = profession !== '' && email !== '' && email.includes('@');
      } else if (currentMode === 'beta') {
        const sex = document.querySelector('input[name="sex"]:checked');
        const age = document.getElementById('age').value;
        const category = document.querySelector('input[name="category"]:checked');
        isValid = sex !== null && age !== '' && category !== null;
      }

      document.getElementById('start-survey-btn').disabled = !isValid;
    }

    function validateComments() {
      const comments = document.getElementById('comments').value.trim();
      document.getElementById('submit-survey-btn').disabled = comments === '';
      // Save comments as user types
      if (currentSession) {
        currentSession.comments = comments;
        saveSessionState();
      }
    }

    function goToMetricSelection() {
      const name = document.getElementById('respondent-name').value;
      currentSession.personalInfo.name = name;

      if (currentMode === 'alpha') {
        const profession = document.getElementById('profession').value.trim();
        const email = document.getElementById('email').value.trim();

        if (!profession || !email) {
          alert('Please fill in all required fields (Profession and Email).');
          return;
        }

        currentSession.personalInfo.profession = profession;
        currentSession.personalInfo.email = email;
      } else {
        const sex = document.querySelector('input[name="sex"]:checked');
        const age = document.getElementById('age').value;
        const category = document.querySelector('input[name="category"]:checked');

        if (!sex || !age || !category) {
          alert('Please fill in all required fields (Sex, Age, and Category).');
          return;
        }

        currentSession.personalInfo.sex = sex.value;
        currentSession.personalInfo.age = age;
        currentSession.personalInfo.category = category.value;
      }

      renderMetricList();
      showScreen('metric-screen');
      currentScreen = 'metric-screen';
      saveSessionState();
    }

    function renderMetricList() {
      const mode = surveyData[currentMode];
      document.getElementById('metric-title').textContent = mode.title;
      const list = document.getElementById('metric-list');
      list.innerHTML = '';

      let completed = 0;
      Object.keys(mode.metrics).forEach((key, idx) => {
        const metric = mode.metrics[key];
        const responses = currentSession.responses[key] || {};
        const answeredCount = Object.keys(responses).length;
        const isComplete = answeredCount === 5;
        if (isComplete) completed++;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `w-full p-3.5 rounded-xl border-2 transition-all duration-200 active:scale-95 animate-slide-in flex items-center gap-3 ${isComplete ? 'bg-green-50 dark:bg-green-900/20 border-green-400' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-primary'}`;
        btn.style.animationDelay = `${idx * 0.2}s`;
        btn.onclick = () => startMetricScoring(key);

        let statusText = '';
        if (isComplete) {
          statusText = 'Completed';
        } else if (answeredCount > 0) {
          statusText = `Answered ${answeredCount} of 5`;
        } else {
          statusText = '5 questions';
        }

        btn.innerHTML = `
      <div class="w-10 h-10 rounded-full ${isComplete ? 'bg-green-500 text-white' : 'bg-primary/20 text-primary'} flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-xl">${isComplete ? 'check' : metric.icon}</span>
      </div>
      <div class="flex-1 text-left">
        <h3 class="font-bold text-sm">${metric.name}</h3>
        <p class="text-xs text-gray-600 dark:text-gray-400">${statusText}</p>
      </div>
      <span class="material-symbols-outlined text-xl text-gray-400">arrow_forward_ios</span>
    `;

        list.appendChild(btn);
      });

      // Add "Complete Survey" button if all metrics are done but comments aren't
      const allMetricsComplete = completed === 5;
      const commentsComplete = currentSession.comments && currentSession.comments.trim() !== '';

      if (allMetricsComplete && !commentsComplete) {
        const completeBtn = document.createElement('button');
        completeBtn.type = 'button';
        completeBtn.className = 'w-full p-3.5 rounded-xl border-2 border-orange-400 bg-orange-50 dark:bg-orange-900/20 transition-all duration-200 active:scale-95 animate-slide-in flex items-center gap-3 mt-4';
        completeBtn.style.animationDelay = '1s';
        completeBtn.onclick = () => {
          document.getElementById('submit-survey-btn').disabled = true;
          document.getElementById('comments').value = currentSession.comments || '';
          showScreen('comments-screen');
          currentScreen = 'comments-screen';
          saveSessionState();
        };

        completeBtn.innerHTML = `
      <div class="w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-xl">edit_note</span>
      </div>
      <div class="flex-1 text-left">
        <h3 class="font-bold text-sm">Complete Survey</h3>
        <p class="text-xs text-gray-600 dark:text-gray-400">Provide comments and submit</p>
      </div>
      <span class="material-symbols-outlined text-xl text-orange-600">arrow_forward_ios</span>
    `;

        list.appendChild(completeBtn);
      }

      document.getElementById('metric-progress-text').textContent = `${completed} of 5`;
      document.getElementById('metric-progress-bar').style.width = `${(completed / 5) * 100}%`;
    }

    function startMetricScoring(metricKey) {
      currentMetric = metricKey;

      if (!currentSession.responses[metricKey]) {
        currentSession.responses[metricKey] = {};
      }

      const responses = currentSession.responses[metricKey];
      const answeredIndices = Object.keys(responses).map(k => parseInt(k));

      if (answeredIndices.length === 5) {
        currentItemIndex = 0;
      } else if (answeredIndices.length > 0) {
        for (let i = 0; i < 5; i++) {
          if (!answeredIndices.includes(i)) {
            currentItemIndex = i;
            break;
          }
        }
      } else {
        currentItemIndex = 0;
      }

      showScoringScreen();
      saveSessionState();
    }

    function showScoringScreen() {
      const mode = surveyData[currentMode];
      const metric = mode.metrics[currentMetric];

      document.getElementById('scoring-metric-name').textContent = metric.name;
      document.getElementById('scoring-progress-text').textContent = `Question ${currentItemIndex + 1} of 5`;
      document.getElementById('scoring-progress-bar').style.width = `${((currentItemIndex + 1) / 5) * 100}%`;
      document.getElementById('scoring-question').textContent = metric.items[currentItemIndex];

      updateNavigationButtons();

      const previousAnswer = currentSession.responses[currentMetric][currentItemIndex];
      highlightSelectedScore(previousAnswer);

      showScreen('scoring-screen');
      currentScreen = 'scoring-screen';
      saveSessionState();
    }

    function selectScore(score) {
      document.querySelectorAll('.score-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-primary', 'scale-105');
      });

      const selectedBtn = document.querySelector(`.score-btn[data-score="${score}"]`);
      selectedBtn.classList.add('ring-4', 'ring-primary', 'scale-105');

      // Store temporarily but don't save to session yet
      selectedBtn.dataset.tempScore = score;
      document.getElementById('next-question-btn').disabled = false;
      // Don't save here anymore
    }

    function highlightSelectedScore(score) {
      document.querySelectorAll('.score-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-primary', 'scale-105');
      });

      if (score !== undefined) {
        const selectedBtn = document.querySelector(`.score-btn[data-score="${score}"]`);
        if (selectedBtn) {
          selectedBtn.classList.add('ring-4', 'ring-primary', 'scale-105');
          document.getElementById('next-question-btn').disabled = false;
        }
      } else {
        document.getElementById('next-question-btn').disabled = true;
      }
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prev-question-btn');
      const nextBtn = document.getElementById('next-question-btn');

      if (currentItemIndex === 0) {
        prevBtn.disabled = true;
        prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        prevBtn.disabled = false;
        prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      if (currentItemIndex === 4) {
        nextBtn.innerHTML = '<span class="text-xs">Finish</span><span class="material-symbols-outlined text-lg">check</span>';
      } else {
        nextBtn.innerHTML = '<span class="text-xs">Next</span><span class="material-symbols-outlined text-lg">arrow_forward</span>';
      }
    }

    function nextQuestion() {
      // Get the temporarily selected score
      const selectedBtn = document.querySelector('.score-btn.ring-4.ring-primary');

      if (!selectedBtn || !selectedBtn.dataset.tempScore) {
        alert('Please select an answer before proceeding.');
        return;
      }

      // NOW save the score
      const score = parseInt(selectedBtn.dataset.tempScore);
      currentSession.responses[currentMetric][currentItemIndex] = score;
      saveSessionState();

      if (currentItemIndex < 4) {
        currentItemIndex++;
        showScoringScreen();
      } else {
        checkAllMetricsComplete();
      }
    }

    function previousQuestion() {
      if (currentItemIndex > 0) {
        currentItemIndex--;
        showScoringScreen();
      }
    }

    function checkAllMetricsComplete() {
      const mode = surveyData[currentMode];
      const allComplete = Object.keys(mode.metrics).every(key =>
        currentSession.responses[key] && Object.keys(currentSession.responses[key]).length === 5
      );

      if (allComplete) {
        document.getElementById('submit-survey-btn').disabled = true;
        document.getElementById('comments').value = currentSession.comments || ''; // Changed from ''
        showScreen('comments-screen');
        currentScreen = 'comments-screen';
        saveSessionState();
      } else {
        renderMetricList();
        showScreen('metric-screen');
        currentScreen = 'metric-screen';
        saveSessionState();
      }
    }

    function goBackToMetrics() {
      renderMetricList();
      showScreen('metric-screen');
      currentScreen = 'metric-screen';
      saveSessionState();
    }

    async function submitSurvey() {
      const comments = document.getElementById('comments').value.trim();

      if (!comments) {
        alert('Please provide comments and recommendations before submitting.');
        return;
      }

      currentSession.comments = comments;

      // Show loading state
      const submitBtn = document.getElementById('submit-survey-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner"></div>';
      submitBtn.disabled = true;

      try {
        // Save to Firebase first
        const docRef = await db.collection('survey_responses').add(currentSession);

        // Add Firebase ID to the session for duplicate tracking
        currentSession.firebaseId = docRef.id;

        // Update local storage - replace existing entry if any
        const stored = localStorage.getItem('mindease-responses');
        let allResponses = stored ? JSON.parse(stored) : [];

        // Remove any existing entry with same timestamp/email to prevent duplicates
        const key = currentSession.timestamp + (currentSession.personalInfo?.email || '');
        allResponses = allResponses.filter(r =>
          (r.timestamp + (r.personalInfo?.email || '')) !== key
        );

        // Add the new response
        allResponses.push(currentSession);
        localStorage.setItem('mindease-responses', JSON.stringify(allResponses));

        clearSessionState();
        showScreen('success-screen');
        currentScreen = 'success-screen';
      } catch (error) {
        console.error('Error saving to Firebase:', error);
        alert('Failed to submit survey. Please check your internet connection and try again.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    function resetSurvey() {
      currentSession = null;
      currentMode = null;
      currentMetric = null;
      currentItemIndex = 0;
      currentScreen = 'home-tab';

      document.getElementById('respondent-name').value = '';
      document.getElementById('comments').value = '';
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.getElementById('consent-agree-btn').disabled = true;

      if (document.getElementById('profession')) document.getElementById('profession').value = '';
      if (document.getElementById('email')) document.getElementById('email').value = '';
      if (document.getElementById('age')) document.getElementById('age').value = '';

      clearSessionState();
      showHomeTab();
    }

    async function loadResults() {
      const container = document.getElementById('results-content');
      container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner"></div><p class="mt-4 text-gray-600">Loading results...</p></div>';

      try {
        // Try to get data from Firebase first
        const snapshot = await db.collection('survey_responses').get();
        const firebaseResponses = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // Add Firebase document ID to prevent duplicates
          data.firebaseId = doc.id;
          firebaseResponses.push(data);
        });

        // Also get local data
        const stored = localStorage.getItem('mindease-responses');
        const localResponses = stored ? JSON.parse(stored) : [];

        // Create a Set to track unique responses using timestamp + email as key
        const uniqueKeys = new Set();
        const mergedResponses = [];

        // First add Firebase responses (prioritize these)
        firebaseResponses.forEach(response => {
          const key = response.timestamp + (response.personalInfo?.email || '');
          if (!uniqueKeys.has(key)) {
            uniqueKeys.add(key);
            mergedResponses.push(response);
          }
        });

        // Then add local responses only if they don't exist in Firebase
        localResponses.forEach(response => {
          const key = response.timestamp + (response.personalInfo?.email || '');
          if (!uniqueKeys.has(key)) {
            uniqueKeys.add(key);
            mergedResponses.push(response);
          }
        });

        allResponses = mergedResponses;

        // Update localStorage with merged data (remove duplicates)
        localStorage.setItem('mindease-responses', JSON.stringify(allResponses));

        updateResultsView();
      } catch (error) {
        console.error('Error loading from Firebase:', error);
        // Fall back to local storage
        const stored = localStorage.getItem('mindease-responses');
        allResponses = stored ? JSON.parse(stored) : [];
        updateResultsView();
      }
    }

    let lastMode = null;

    function updateResultsView() {
      const mode = document.getElementById('results-mode-select').value;
      const filterSelect = document.getElementById('results-filter-select');
      const container = document.getElementById('results-content');

      // Rebuild filter options only when mode changes
      if (mode !== lastMode) {
        buildFilterOptions();
        lastMode = mode;
      }

      const filterVal = filterSelect.value;

      // Clear previous content
      container.innerHTML = '';

      if (!mode) {
        container.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <span class="material-symbols-outlined text-6xl mb-3">bar_chart</span>
        <p>Select a testing mode to view results</p>
      </div>`;
        return;
      }

      const modeResponses = allResponses.filter(r => r.mode === mode);
      if (modeResponses.length === 0) {
        container.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <span class="material-symbols-outlined text-6xl mb-3">inbox</span>
        <p>No responses yet</p>
      </div>`;
        return;
      }

      const modeData = surveyData[mode];
      const overallStats = calculateOverallStatistics(modeResponses, modeData);

      // === Render Overall Summary ===
      let html = `
    <div class="bg-primary/10 border-2 border-primary rounded-xl p-4 mb-4">
      <h3 class="text-lg font-bold">${modeData.title}</h3>
      <p class="text-primary font-bold text-xl mt-1">${modeResponses.length} Total Responses</p>
    </div>
  `;

      if (filterVal === 'comments') {
        html += `
      <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">chat</span>
          User Comments and Recommendations
        </h3>
        <div class="space-y-4">
          ${modeResponses.map((response, index) => {
          const name = response.personalInfo.name || 'Anonymous';
          const timestamp = new Date(response.timestamp).toLocaleString();
          const comments = response.comments || 'No comments provided.';
          return `
              <div class="border-l-4 border-primary pl-4 py-2">
                <div class="flex justify-between items-start mb-2">
                  <p class="font-bold text-sm">${name}</p>
                  <p class="text-xs text-gray-500">${timestamp}</p>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">${comments}</p>
              </div>
            `;
        }).join('')}
        </div>
      </div>
    `;
        container.innerHTML = html;
        return;
      }

      // === Overall Stats ===
      html += `
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700 mb-4">
      <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">analytics</span>
        Overall Statistics Summary
      </h3>
      <div class="grid grid-cols-3 gap-3 mb-3">
        <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
          <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Grand Mean</p>
          <p class="text-2xl font-bold text-primary">${overallStats.grandMean}</p>
        </div>
        <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-xl">
          <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Std. Dev.</p>
          <p class="text-2xl font-bold text-green-600">${overallStats.grandStdDev}</p>
        </div>
        <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
          <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Items</p>
          <p class="text-2xl font-bold text-purple-600">${overallStats.totalItems}</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="text-left p-2 font-bold">Metric</th>
              <th class="text-center p-2 font-bold">Mean</th>
              <th class="text-center p-2 font-bold">Std. Dev.</th>
              <th class="text-center p-2 font-bold">Interpretation</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            ${Object.keys(modeData.metrics).map(metricKey => {
        const stats = overallStats.metricStats[metricKey];
        const interpretation = interpretScore(stats.mean);
        return `
                <tr>
                  <td class="p-2 font-medium">${modeData.metrics[metricKey].name}</td>
                  <td class="text-center p-2 font-bold text-primary">${stats.mean}</td>
                  <td class="text-center p-2">${stats.stdDev}</td>
                  <td class="text-center p-2">
                    <span class="px-2 py-0.5 rounded-full text-xs font-bold ${interpretation.color}">
                      ${interpretation.label}
                    </span>
                  </td>
                </tr>
              `;
      }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

      container.innerHTML = html;

      // === Render Individual Metrics ===
      Object.keys(modeData.metrics).forEach(metricKey => {
        if (filterVal !== 'all' && filterVal !== metricKey) return;

        const metric = modeData.metrics[metricKey];
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700 mb-4';

        let metricHtml = `<h3 class="text-lg font-bold mb-3 flex items-center gap-2">
      <span class="material-symbols-outlined text-primary">${metric.icon}</span>
      ${metric.name}
    </h3>`;

        metric.items.forEach((item, itemIdx) => {
          const scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
          let total = 0, sum = 0, sumSquares = 0;

          modeResponses.forEach(resp => {
            if (resp.responses[metricKey]?.[itemIdx] !== undefined) {
              const score = resp.responses[metricKey][itemIdx];
              scores[score]++;
              sum += score;
              sumSquares += score * score;
              total++;
            }
          });

          const mean = total > 0 ? (sum / total).toFixed(2) : '0.00';
          const variance = total > 0 ? (sumSquares / total) - (mean * mean) : 0;
          const stdDev = total > 0 ? Math.sqrt(variance).toFixed(2) : '0.00';
          const percentages = {};
          [1, 2, 3, 4, 5].forEach(s => {
            percentages[s] = total > 0 ? ((scores[s] / total) * 100).toFixed(1) : '0.0';
          });

          metricHtml += `
        <div class="mb-3 pb-3 ${itemIdx < 4 ? 'border-b border-gray-200 dark:border-gray-700' : ''}">
          <p class="font-medium text-xs mb-2">${itemIdx + 1}. ${item}</p>
          <div class="flex items-center gap-2 mb-2">
            <div class="flex-1 flex gap-1 h-6">
              ${[1, 2, 3, 4, 5].map(s => `
                <div class="${['bg-red-400', 'bg-orange-400', 'bg-amber-400', 'bg-blue-400', 'bg-green-400'][s - 1]}"
                     style="width: ${percentages[s]}%" title="Score ${s}: ${scores[s]} (${percentages[s]}%)"></div>
              `).join('')}
            </div>
            <div class="text-right min-w-16">
              <p class="text-xl font-bold text-primary">${mean}</p>
              <p class="text-xs text-gray-500">${total} resp.</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2">
              <p class="text-gray-600 dark:text-gray-400">Std. Dev.</p>
              <p class="font-bold text-primary">${stdDev}</p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-2">
              <p class="text-gray-600 dark:text-gray-400">Responses</p>
              <p class="font-bold text-purple-600">${total}</p>
            </div>
          </div>
        </div>
      `;
        });

        card.innerHTML = metricHtml;
        container.appendChild(card);
      });

      // === Add Comments if "All" is selected ===
      if (filterVal === 'all') {
        const commentsCard = document.createElement('div');
        commentsCard.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700 mb-4';
        commentsCard.innerHTML = `
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">chat</span>
        User Comments and Recommendations
      </h3>
      <div class="space-y-4">
        ${modeResponses.map(r => {
          const name = r.personalInfo.name || 'Anonymous';
          const time = new Date(r.timestamp).toLocaleString();
          const comment = r.comments || 'No comments.';
          return `
            <div class="border-l-4 border-primary pl-4 py-2">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-sm">${name}</p>
                <p class="text-xs text-gray-500">${time}</p>
              </div>
              <p class="text-sm text-gray-700 dark:text-gray-300">${comment}</p>
            </div>
          `;
        }).join('')}
      </div>
    `;
        container.appendChild(commentsCard);
      }
    }

    function calculateOverallStatistics(responses, modeData) {
      const metricStats = {};
      let grandSum = 0;
      let grandCount = 0;
      let grandSumSquares = 0;
      const scoreDistribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
      let totalItems = 0;

      Object.keys(modeData.metrics).forEach(metricKey => {
        const metric = modeData.metrics[metricKey];
        let metricSum = 0;
        let metricCount = 0;
        let metricSumSquares = 0;

        metric.items.forEach((item, itemIdx) => {
          responses.forEach(resp => {
            if (resp.responses[metricKey] && resp.responses[metricKey][itemIdx] !== undefined) {
              const score = resp.responses[metricKey][itemIdx];
              metricSum += score;
              metricSumSquares += score * score;
              metricCount++;
              grandSum += score;
              grandSumSquares += score * score;
              grandCount++;
              scoreDistribution[score]++;
            }
          });
        });

        totalItems += metric.items.length;

        const metricMean = metricCount > 0 ? (metricSum / metricCount) : 0;
        const metricVariance = metricCount > 0 ? (metricSumSquares / metricCount) - (metricMean * metricMean) : 0;
        const metricStdDev = metricCount > 0 ? Math.sqrt(metricVariance) : 0;

        metricStats[metricKey] = {
          mean: metricMean.toFixed(2),
          stdDev: metricStdDev.toFixed(2)
        };
      });

      const grandMean = grandCount > 0 ? (grandSum / grandCount) : 0;
      const grandVariance = grandCount > 0 ? (grandSumSquares / grandCount) - (grandMean * grandMean) : 0;
      const grandStdDev = grandCount > 0 ? Math.sqrt(grandVariance) : 0;

      return {
        grandMean: grandMean.toFixed(2),
        grandStdDev: grandStdDev.toFixed(2),
        metricStats,
        scoreDistribution,
        totalResponses: grandCount,
        totalItems
      };
    }

    function interpretScore(mean) {
      const score = parseFloat(mean);
      if (score >= 4.5) return { label: 'Excellent', color: 'bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-400' };
      if (score >= 3.5) return { label: 'Good', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400' };
      if (score >= 2.5) return { label: 'Fair', color: 'bg-amber-100 text-amber-700 dark:bg-amber-900/20 dark:text-amber-400' };
      if (score >= 1.5) return { label: 'Poor', color: 'bg-orange-100 text-orange-700 dark:bg-orange-900/20 dark:text-orange-400' };
      return { label: 'Very Poor', color: 'bg-red-100 text-red-700 dark:bg-red-900/20 dark:text-red-400' };
    }

    function exportAllResults() {
      const mode = document.getElementById('results-mode-select').value;
      if (!mode) {
        alert('Please select a testing mode first.');
        return;
      }

      const modeResponses = allResponses.filter(r => r.mode === mode);
      if (modeResponses.length === 0) {
        alert('No data to export.');
        return;
      }

      const modeData = surveyData[mode];
      let csv = 'Timestamp,Name,';

      if (mode === 'alpha') {
        csv += 'Profession,Email,';
      } else {
        csv += 'Sex,Age,Category,';
      }

      Object.keys(modeData.metrics).forEach(metricKey => {
        const metric = modeData.metrics[metricKey];
        metric.items.forEach((item, idx) => {
          csv += `"${metric.name} Q${idx + 1}",`;
        });
      });

      csv += 'Comments\n';

      modeResponses.forEach(response => {
        const row = [];
        row.push(response.timestamp);
        row.push(response.personalInfo.name || 'Anonymous');

        if (mode === 'alpha') {
          row.push(response.personalInfo.profession || '');
          row.push(response.personalInfo.email || '');
        } else {
          row.push(response.personalInfo.sex || '');
          row.push(response.personalInfo.age || '');
          row.push(response.personalInfo.category || '');
        }

        Object.keys(modeData.metrics).forEach(metricKey => {
          const metric = modeData.metrics[metricKey];
          metric.items.forEach((item, idx) => {
            const score = response.responses[metricKey] ? response.responses[metricKey][idx] : '';
            row.push(score);
          });
        });

        row.push(`"${(response.comments || '').replace(/"/g, '""')}"`);
        csv += row.join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mindease-${mode}-results-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function clearDataPrompt() {
      document.getElementById('clear-modal').style.display = 'flex';
    }

    function closeClearModal() {
      document.getElementById('clear-modal').style.display = 'none';
    }

    async function clearData(type) {
      if (type === 'all') {
        if (confirm('Are you absolutely sure? This will delete ALL survey data permanently!')) {
          // Clear Firebase data
          try {
            const snapshot = await db.collection('survey_responses').get();
            const batch = db.batch();
            snapshot.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          } catch (error) {
            console.error('Error clearing Firebase data:', error);
          }

          // Clear local data
          localStorage.removeItem('mindease-responses');
          allResponses = [];
          closeClearModal();
          updateResultsView();
          alert('All data has been cleared.');
        }
      } else {
        if (confirm(`Are you sure you want to clear all ${type === 'alpha' ? 'Alpha' : 'Beta'} Testing data?`)) {
          // Clear from Firebase
          try {
            const snapshot = await db.collection('survey_responses').where('mode', '==', type).get();
            const batch = db.batch();
            snapshot.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          } catch (error) {
            console.error('Error clearing Firebase data:', error);
          }

          // Clear from local storage
          allResponses = allResponses.filter(r => r.mode !== type);
          localStorage.setItem('mindease-responses', JSON.stringify(allResponses));
          closeClearModal();
          updateResultsView();
          alert(`${type === 'alpha' ? 'Alpha' : 'Beta'} Testing data has been cleared.`);
        }
      }
    }

    // Load responses and restore session on page load
    window.addEventListener('DOMContentLoaded', () => {
      const stored = localStorage.getItem('mindease-responses');
      if (stored) {
        allResponses = JSON.parse(stored);
      }

      // Try to restore previous session
      const restored = loadSessionState();
      if (restored && currentScreen !== 'home-tab' && currentScreen !== 'results-tab') {
        // Show the restored screen
        if (currentScreen === 'metric-screen') {
          renderMetricList();
        } else if (currentScreen === 'scoring-screen') {
          showScoringScreen();
        }
        showScreen(currentScreen);
      }
      buildFilterOptions();
    });
  </script>
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('./service-worker.js')
          .then(function (registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(function (error) {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
  </script>
</body>

</html>
